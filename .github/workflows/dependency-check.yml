name: Dependency Monitor

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  check-frontend-dependencies:
    name: Check Frontend Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Check for updates
        working-directory: frontend
        run: |
          echo "ğŸ” Checking for npm dependency updates..."

          # Check for outdated packages
          npm outdated || true

          # Store output for later use
          npm outdated --json > outdated.json 2>/dev/null || echo "{}" > outdated.json

      - name: Security audit
        working-directory: frontend
        run: |
          echo "ğŸ”’ Running npm security audit..."

          # Run security audit
          npm audit --audit-level=moderate || true

          # Store audit results
          npm audit --json > audit.json 2>/dev/null || echo '{"vulnerabilities":{}}' > audit.json

      - name: Analyze results
        working-directory: frontend
        run: |
          echo "ğŸ“Š Analyzing dependency status..."

          # Check if any packages are outdated
          OUTDATED_COUNT=$(node -e "
            const data = JSON.parse(require('fs').readFileSync('outdated.json', 'utf8'));
            console.log(Object.keys(data).length);
          ")

          # Check security vulnerabilities (count total vulns, not just affected packages)
          VULN_COUNT=$(node -e "
            const data = JSON.parse(require('fs').readFileSync('audit.json', 'utf8'));
            const metadata = data.vulnerabilities || {};
            // Count total vulnerabilities across all packages
            let total = 0;
            for (const pkg in metadata) {
              const vulnInfo = metadata[pkg];
              // Count via array length (each via entry is a vulnerability)
              if (vulnInfo.via && Array.isArray(vulnInfo.via)) {
                total += vulnInfo.via.filter(v => typeof v === 'object').length;
              }
            }
            console.log(total);
          ")

          echo "â”œâ”€â”€ Outdated packages: $OUTDATED_COUNT"
          echo "â”œâ”€â”€ Security vulnerabilities: $VULN_COUNT"

          # Set environment variables
          echo "OUTDATED_COUNT=$OUTDATED_COUNT" >> $GITHUB_ENV
          echo "VULN_COUNT=$VULN_COUNT" >> $GITHUB_ENV

      - name: Create issue for updates
        if: env.OUTDATED_COUNT != '0' || env.VULN_COUNT != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const outdatedData = JSON.parse(fs.readFileSync('frontend/outdated.json', 'utf8'));
            const auditData = JSON.parse(fs.readFileSync('frontend/audit.json', 'utf8'));

            let issueBody = "## ğŸ“¦ Frontend Dependency Status Report\n\n";

            // Outdated packages
            if (Object.keys(outdatedData).length > 0) {
              issueBody += "### ğŸ“ˆ Outdated Packages\n\n";
              Object.entries(outdatedData).forEach(([pkg, info]) => {
                issueBody += `- **${pkg}**: ${info.current} â†’ ${info.latest}\n`;
              });
              issueBody += "\n";
            }

            // Security vulnerabilities
            const vulns = auditData.vulnerabilities || {};
            if (Object.keys(vulns).length > 0) {
              issueBody += "### ğŸ”’ Security Vulnerabilities\n\n";
              Object.entries(vulns).forEach(([pkg, vuln]) => {
                issueBody += `- **${pkg}**: ${vuln.severity} severity\n`;
              });
              issueBody += "\n";
            }

            issueBody += `### ğŸ”§ Recommended Actions\n\n`;
            if (Object.keys(outdatedData).length > 0) {
              issueBody += `- Run \`cd frontend && npm update\` to update packages\n`;
            }
            if (Object.keys(vulns).length > 0) {
              issueBody += `- Run \`cd frontend && npm audit fix\` to fix vulnerabilities\n`;
            }
            issueBody += `- Test thoroughly after updates\n`;
            issueBody += `- Update package-lock.json if needed\n\n`;
            issueBody += `> ğŸ¤– This issue was automatically created by the dependency monitor workflow.`;

            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'dependencies,frontend',
              state: 'open'
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“¦ Frontend Dependency Updates Available',
                body: issueBody,
                labels: ['dependencies', 'maintenance', 'frontend']
              });

              console.log('âœ… Created dependency update issue');
            } else {
              console.log('â„¹ï¸  Dependency update issue already exists');
            }

      - name: Summary
        run: |
          echo "ğŸ¯ Dependency Check Summary:"
          echo "â”œâ”€â”€ âœ… npm dependencies checked"
          echo "â”œâ”€â”€ âœ… Security audit completed"
          echo "â”œâ”€â”€ Outdated packages: ${{ env.OUTDATED_COUNT }}"
          echo "â”œâ”€â”€ Security vulnerabilities: ${{ env.VULN_COUNT }}"

          if [ "${{ env.OUTDATED_COUNT }}" != "0" ] || [ "${{ env.VULN_COUNT }}" != "0" ]; then
            echo "â”œâ”€â”€ ğŸ“¦ Updates needed - issue created"
          else
            echo "â”œâ”€â”€ âœ… All dependencies up to date and secure"
          fi

          echo "â””â”€â”€ ğŸ”„ Next check scheduled for next Monday"

  check-backend-dependencies:
    name: Check Backend Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Check for vulnerabilities
        working-directory: backend
        run: |
          echo "ğŸ”’ Running pip security audit..."
          pip-audit -r requirements.txt --format json > audit.json || true
          cat audit.json

      - name: Analyze results
        working-directory: backend
        run: |
          echo "ğŸ“Š Analyzing dependency status..."

          # Check vulnerabilities
          if [ -f "audit.json" ]; then
            VULN_COUNT=$(python3 -c "import json; data=json.load(open('audit.json')); print(sum(len(dep.get('vulns', [])) for dep in data.get('dependencies', [])))" 2>/dev/null || echo "0")
            echo "â”œâ”€â”€ Security vulnerabilities: $VULN_COUNT"
            echo "BACKEND_VULN_COUNT=$VULN_COUNT" >> $GITHUB_ENV
          else
            echo "â”œâ”€â”€ Security vulnerabilities: 0"
            echo "BACKEND_VULN_COUNT=0" >> $GITHUB_ENV
          fi

      - name: Create issue for updates
        if: env.BACKEND_VULN_COUNT != '0'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let issueBody = "## ğŸ“¦ Backend Dependency Status Report\n\n";

            try {
              const auditData = JSON.parse(fs.readFileSync('backend/audit.json', 'utf8'));
              const vulns = auditData.dependencies || [];

              if (vulns.length > 0) {
                issueBody += "### ğŸ”’ Security Vulnerabilities\n\n";
                vulns.forEach(vuln => {
                  issueBody += `- **${vuln.name}** (${vuln.version}): ${vuln.vulns.length} vulnerabilities\n`;
                });
                issueBody += "\n";
              }
            } catch (e) {
              issueBody += "Error reading audit results. Check workflow logs for details.\n\n";
            }

            issueBody += `### ğŸ”§ Recommended Actions\n\n`;
            issueBody += `- Review vulnerabilities in backend dependencies\n`;
            issueBody += `- Update affected packages in requirements.txt\n`;
            issueBody += `- Test thoroughly after updates\n\n`;
            issueBody += `> ğŸ¤– This issue was automatically created by the dependency monitor workflow.`;

            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'dependencies,backend',
              state: 'open'
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“¦ Backend Dependency Updates Available',
                body: issueBody,
                labels: ['dependencies', 'maintenance', 'backend']
              });

              console.log('âœ… Created dependency update issue');
            } else {
              console.log('â„¹ï¸  Dependency update issue already exists');
            }

      - name: Summary
        run: |
          echo "ğŸ¯ Dependency Check Summary:"
          echo "â”œâ”€â”€ âœ… Python dependencies checked"
          echo "â”œâ”€â”€ Security vulnerabilities: ${{ env.BACKEND_VULN_COUNT }}"

          if [ "${{ env.BACKEND_VULN_COUNT }}" != "0" ]; then
            echo "â”œâ”€â”€ ğŸ“¦ Updates needed - issue created"
          else
            echo "â”œâ”€â”€ âœ… All dependencies up to date and secure"
          fi

          echo "â””â”€â”€ ğŸ”„ Next check scheduled for next Monday"
