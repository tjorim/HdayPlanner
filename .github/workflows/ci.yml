name: HdayPlanner CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent concurrent runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-frontend:
    name: Validate Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Validate TypeScript
        working-directory: frontend
        run: |
          echo "Validating TypeScript files..."
          npx tsc --noEmit
          echo "âœ… TypeScript validation passed"

      - name: Run tests
        working-directory: frontend
        run: |
          echo "Running test suite..."
          npm run test
          echo "âœ… All tests passed"

      - name: Build frontend
        working-directory: frontend
        run: |
          echo "Building frontend with Vite..."
          npm run build

          echo "Checking built files..."
          # Check if build output exists
          [ -f "dist/index.html" ] && echo "âœ… Built index.html found" || { echo "âŒ Built index.html missing"; exit 1; }

          # Check for built CSS
          if ls dist/assets/*.css 1> /dev/null 2>&1; then
            echo "âœ… Built CSS files found"
          else
            echo "âŒ Built CSS files missing"
            exit 1
          fi

          # Check for built JS
          if ls dist/assets/*.js 1> /dev/null 2>&1; then
            echo "âœ… Built JS files found"
          else
            echo "âŒ Built JS files missing"
            exit 1
          fi

          echo "âœ… Frontend build successful"

      - name: Calculate bundle size
        working-directory: frontend
        run: |
          echo "Calculating bundle size..."

          # Calculate built bundle size
          DIST_SIZE=$(du -sb dist/ | cut -f1)
          TOTAL_KB=$(( (DIST_SIZE + 1023) / 1024 ))

          echo "ğŸ“Š Bundle Size Analysis:"
          echo "â””â”€â”€ Total: ${TOTAL_KB}KB"

          # List built files for transparency
          echo ""
          echo "ğŸ“ Built files:"
          find dist -type f -exec ls -lh {} \; | awk '{print "â”œâ”€â”€ " $9 ": " $5}'

          # Bundle size check (warn if over 500KB)
          if [ $TOTAL_KB -gt 500 ]; then
            echo "âš ï¸  Bundle size is large (${TOTAL_KB}KB > 500KB)"
          else
            echo "âœ… Bundle size is optimal (${TOTAL_KB}KB)"
          fi

          # Save for PR comment
          echo "BUNDLE_SIZE=${TOTAL_KB}KB" >> $GITHUB_ENV

      - name: Validate .hday parser
        working-directory: frontend
        run: |
          echo "Validating .hday file parser..."
          # The parser tests are already run in the test suite
          # This is just a verification step
          [ -f "src/lib/hday.ts" ] && echo "âœ… Parser module found" || { echo "âŒ Parser missing"; exit 1; }
          [ -f "src/lib/hday.test.ts" ] && echo "âœ… Parser tests found" || { echo "âŒ Parser tests missing"; exit 1; }
          echo "âœ… .hday parser validated"

      - name: Build comment body
        if: github.event_name == 'pull_request'
        id: build-comment
        run: |
          {
            echo 'COMMENT_BODY<<EOF'
            echo "## ğŸš€ Frontend Validation Results"
            echo ""
            echo "âœ… TypeScript validation passed"
            echo "âœ… Tests passed (Vitest)"
            echo "âœ… Build successful (Vite)"
            echo "âœ… .hday parser validated"
            echo ""
            echo "ğŸ“Š **Bundle Size:** ${BUNDLE_SIZE}"
            echo ""
            echo "Ready for deployment! ğŸ‰"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/upsert-comment
        with:
          comment-identifier: 'ğŸš€ Frontend Validation Results'
          comment-body: ${{ env.COMMENT_BODY }}

  validate-backend:
    name: Validate Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: backend
        run: |
          echo "Installing Python dependencies..."
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"

      - name: Validate Python syntax
        working-directory: backend
        run: |
          echo "Validating Python syntax..."
          python -m py_compile $(find . -name "*.py")
          echo "âœ… Python syntax is valid"

      - name: Check backend structure
        working-directory: backend
        run: |
          echo "Checking backend structure..."
          [ -f "app/main.py" ] && echo "âœ… FastAPI main.py found" || { echo "âŒ main.py missing"; exit 1; }
          [ -f "requirements.txt" ] && echo "âœ… requirements.txt found" || { echo "âŒ requirements.txt missing"; exit 1; }
          [ -d "app/hday" ] && echo "âœ… hday module found" || { echo "âŒ hday module missing"; exit 1; }
          echo "âœ… Backend structure validated"
