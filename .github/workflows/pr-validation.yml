name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-changes:
    name: Validate PR Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full history for comparison

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Analyze changed files
        run: |
          echo "üîç Analyzing PR changes..."

          # Fetch the base branch for comparison (works on forks)
          if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "${{ github.event.pull_request.base.repo.full_name }}" ]; then
            echo "üì• Fetching PR base: ${{ github.event.pull_request.base.repo.full_name }}/${{ github.event.pull_request.base.ref }}"

            # Add the base repository as a remote and fetch from it (handles forks properly)
            BASE_REPO_URL="https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git"
            git remote add base_repo "$BASE_REPO_URL" 2>/dev/null || true
            git fetch --no-tags --depth=1 base_repo ${{ github.event.pull_request.base.ref }} || {
              echo "‚ö†Ô∏è  Failed to fetch from PR base repository, falling back to origin default branch"
              git fetch --no-tags --depth=1 origin ${{ github.event.repository.default_branch }}
            }
            CHANGED_FILES=$(git diff --name-only FETCH_HEAD...HEAD)
          else
            echo "üì• Not a PR context, comparing with default branch"
            git fetch --no-tags --depth=1 origin ${{ github.event.repository.default_branch }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.event.repository.default_branch }}...HEAD)
          fi

          echo "üìù Changed files:"
          echo "$CHANGED_FILES" | sed 's/^/‚îú‚îÄ‚îÄ /'

          # Categorize changes
          FRONTEND_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^frontend/.*\.(html|css|js|ts|tsx|jsx)$' || true)
          BACKEND_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^backend/.*\.py$' || true)
          CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '(vite\.config\.(js|ts)|package\.json|tsconfig\.json|requirements\.txt)$' || true)
          WORKFLOW_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.github/workflows' || true)
          DOC_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.(md|txt)$' || true)
          HDAY_FORMAT_CHANGES=$(echo "$CHANGED_FILES" | grep -E 'hday-format-spec\.md|hday\.(ts|py)' || true)

          echo ""
          echo "üìä Change Analysis:"

          if [ -n "$FRONTEND_CHANGES" ]; then
            echo "üîß Frontend changes detected"
            echo "FRONTEND_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$BACKEND_CHANGES" ]; then
            echo "üîß Backend changes detected"
            echo "BACKEND_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$CONFIG_CHANGES" ]; then
            echo "‚öôÔ∏è  Configuration changes detected"
            echo "CONFIG_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$WORKFLOW_CHANGES" ]; then
            echo "‚öôÔ∏è  Workflow changes detected"
            echo "WORKFLOW_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$DOC_CHANGES" ]; then
            echo "üìö Documentation changes detected"
            echo "DOC_CHANGES=true" >> $GITHUB_ENV
          fi

          if [ -n "$HDAY_FORMAT_CHANGES" ]; then
            echo "üìÑ .hday format changes detected"
            echo "HDAY_FORMAT_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Validate frontend changes
        if: env.FRONTEND_CHANGES == 'true'
        working-directory: frontend
        run: |
          echo "üîß Validating frontend changes..."

          npm ci

          # Run TypeScript validation
          if npx tsc --noEmit; then
            echo "‚úÖ TypeScript validation passed"
          else
            echo "‚ùå TypeScript validation failed"
            exit 1
          fi

          # Run tests
          if npm run test; then
            echo "‚úÖ Tests passed"
          else
            echo "‚ùå Tests failed"
            exit 1
          fi

          # Build to ensure no build errors
          npm run build
          echo "‚úÖ Build successful"

      - name: Validate backend changes
        if: env.BACKEND_CHANGES == 'true'
        working-directory: backend
        run: |
          echo "üîß Validating backend changes..."

          pip install -r requirements.txt

          # Validate Python syntax
          if python -m py_compile $(find . -name "*.py"); then
            echo "‚úÖ Python syntax validation passed"
          else
            echo "‚ùå Python syntax validation failed"
            exit 1
          fi

      - name: Check .hday format compatibility
        if: env.HDAY_FORMAT_CHANGES == 'true'
        run: |
          echo "üìÑ Checking .hday format compatibility..."
          echo "‚ö†Ô∏è  .hday format changes detected - ensure backward compatibility!"
          echo "‚úÖ Format documentation should be updated"

      - name: Build PR summary
        id: build-summary
        run: |
          {
            echo 'COMMENT_BODY<<EOF'
            echo "## üîç PR Validation Summary"
            echo ""
            echo "### üìù Changes Detected:"
            [ "$FRONTEND_CHANGES" = "true" ] && echo "- üîß Frontend changes"
            [ "$BACKEND_CHANGES" = "true" ] && echo "- üîß Backend changes"
            [ "$CONFIG_CHANGES" = "true" ] && echo "- ‚öôÔ∏è Configuration changes"
            [ "$WORKFLOW_CHANGES" = "true" ] && echo "- üîÑ Workflow changes"
            [ "$DOC_CHANGES" = "true" ] && echo "- üìö Documentation changes"
            [ "$HDAY_FORMAT_CHANGES" = "true" ] && echo "- üìÑ .hday format changes"
            echo ""
            echo "### ‚úÖ Validation Results:"
            if [ "$FRONTEND_CHANGES" = "true" ]; then
              echo "- ‚úÖ Frontend: TypeScript validated, tests passed, build successful"
            fi
            if [ "$BACKEND_CHANGES" = "true" ]; then
              echo "- ‚úÖ Backend: Python syntax validated"
            fi
            if [ "$HDAY_FORMAT_CHANGES" = "true" ]; then
              echo "- ‚ö†Ô∏è  .hday format: Ensure backward compatibility"
            fi
            echo ""
            echo "### üöÄ Ready for Review"
            echo "All automated checks passed! This PR is ready for manual review."
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Comment PR with summary
        uses: ./.github/actions/upsert-comment
        with:
          comment-identifier: 'üîç PR Validation Summary'
          comment-body: ${{ env.COMMENT_BODY }}
