
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>HDAY Viewer/Editor (Standalone)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--b:#ddd;--bg:#f6f8fa;--p:#1976d2}
  body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:20px; max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  textarea{width:100%;height:220px;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  button{padding:8px 12px;border:1px solid var(--b);border-radius:6px;background:#fff;cursor:pointer}
  button.primary{background:var(--p);color:#fff;border-color:var(--p)}
  .table{border-collapse:collapse;width:100%}
  .table th,.table td{border:1px solid var(--b);padding:6px}
  .badge{display:inline-block;padding:2px 6px;border-radius:4px;margin-right:4px;font-size:12px;background:#eceff1;color:#37474f}
  .badge.holiday{background:#e8f5e9;color:#1b5e20}
  .badge.business{background:#e3f2fd;color:#0d47a1}
  .badge.course{background:#fff3e0;color:#e65100}
  .badge.half_am{background:#ede7f6;color:#4527a0}
  .badge.half_pm{background:#fce4ec;color:#ad1457}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
  .day{border:1px solid var(--b);min-height:90px;padding:6px;border-radius:6px}
  .date{font-weight:600;font-size:12px;color:#555}
  .item{font-size:12px;margin-top:4px}
  label{font-weight:600}
  input,select{padding:6px}
  .controls{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:12px;margin-top:10px}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
<header>
  <h1>HDAY Viewer/Editor</h1>
  <div class="row">
    <input type="file" id="fileIn" accept=".hday,.txt" />
    <button id="download" class="primary">Export as .hday</button>
  </div>
</header>

<p class="muted">Paste your <code>.hday</code> content below (or load a file), click <b>Parse</b>, then edit and <b>Export</b> back to <code>.hday</code>. Flags: <code>a</code>=half AM, <code>p</code>=half PM, <code>b</code>=business, <code>s</code>=course, <code>i</code>=in; weekly entries use <code>d0..d6</code>.</p>

<textarea id="hdayText" placeholder="Example:
2024/12/23-2025/01/05 # Kerstvakantie
p2024/07/17-2024/07/17
a2025/03/25-2025/03/25
"></textarea>
<div class="row" style="margin:10px 0">
  <button id="parse" class="primary">Parse</button>
  <button id="clear">Clear table</button>
</div>

<h2>Events</h2>
<table class="table" id="eventsTable">
  <thead>
    <tr>
      <th>#</th><th>Type</th><th>Start</th><th>End/Weekday</th><th>Flags</th><th>Title</th><th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Add / Edit event</h2>
<div class="controls">
  <div>
    <label>Event type</label><br/>
    <select id="evtType">
      <option value="range">Range (start-end)</option>
      <option value="weekly">Weekly (weekday)</option>
    </select>
  </div>
  <div>
    <label>Title (optional)</label><br/>
    <input id="evtTitle" />
  </div>
  <div id="rangeInputs">
    <label>Start (YYYY/MM/DD)</label><br/>
    <input id="evtStart" placeholder="2025/12/18" /><br/>
    <label>End (YYYY/MM/DD)</label><br/>
    <input id="evtEnd" placeholder="2025/12/18" />
  </div>
  <div id="weeklyInputs" style="display:none">
    <label>Weekday</label><br/>
    <select id="evtWeekday">
      <option value="0">Sun</option><option value="1">Mon</option><option value="2">Tue</option>
      <option value="3">Wed</option><option value="4">Thu</option><option value="5">Fri</option><option value="6">Sat</option>
    </select>
  </div>
  <div>
    <label>Flags</label><br/>
    <label><input type="checkbox" class="flag" value="a"> half_am</label>
    <label><input type="checkbox" class="flag" value="p"> half_pm</label>
    <label><input type="checkbox" class="flag" value="b"> business</label>
    <label><input type="checkbox" class="flag" value="s"> course</label>
    <label><input type="checkbox" class="flag" value="i"> in</label>
  </div>
  <div>
    <button id="add" class="primary">Add / Update</button>
    <button id="resetForm">Reset form</button>
  </div>
</div>

<h2>Month view</h2>
<div class="row">
  <input id="month" type="month" />
  <button id="renderCal">Render</button>
</div>
<div class="calendar" id="calendar"></div>

<script>
  // ===== Utilities =====
  const reRange  = /^(?<prefix>[a-z]*)?(?<start>\d{4}\/\d{2}\/\d{2})(?:-(?<end>\d{4}\/\d{2}\/\d{2}))?(?:\s*#\s*(?<title>.*))?$/i;
  const reWeekly = /^(?<prefix>[a-z]*?)d(?<weekday>[0-6])(?:\s*#\s*(?<title>.*))?$/i;
  const MAP = { a:'half_am', p:'half_pm', b:'business', s:'course', i:'in' };
  const REV = { half_am:'a', half_pm:'p', business:'b', course:'s', in:'i' };

  let events = [];
  let editIndex = -1;

  function parseHday(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for(const ln of lines){
      let m = ln.match(reRange);
      if(m){
        const g=m.groups, flags=[];
        for(const ch of (g.prefix||'')) flags.push(MAP[ch] || ('flag_'+ch));
        if(!flags.some(f=>['business','course','in'].includes(f))) flags.push('holiday');
        out.push({type:'range', start:g.start, end:g.end||g.start, flags, title:(g.title||'').trim(), raw:ln});
        continue;
      }
      let w = ln.match(reWeekly);
      if(w){
        const g=w.groups, flags=[];
        for(const ch of (g.prefix||'')) flags.push(MAP[ch] || ('flag_'+ch));
        if(!flags.some(f=>['business','course','in'].includes(f))) flags.push('holiday');
        out.push({type:'weekly', weekday:parseInt(g.weekday,10), flags, title:(g.title||'').trim(), raw:ln});
        continue;
      }
      out.push({type:'unknown', raw:ln, flags:['holiday']});
    }
    return out;
  }

  function flagsToBadges(flags){ return (flags||[]).map(f=>`<span class="badge ${f}">${f}</span>`).join(''); }

  function renderTable(){
    const tbody = document.querySelector('#eventsTable tbody');
    tbody.innerHTML='';
    events.forEach((ev,i)=>{
      const tr = document.createElement('tr');
      const endOrDay = ev.type==='weekly' ? ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][ev.weekday] : (ev.end||'');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${ev.type}</td>
        <td>${ev.start||''}</td>
        <td>${endOrDay}</td>
        <td>${flagsToBadges(ev.flags)}</td>
        <td>${ev.title||''}</td>
        <td>
          <button data-i="${i}" class="edit">Edit</button>
          <button data-i="${i}" class="del">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button.edit').forEach(b=>b.onclick=()=>loadToForm(parseInt(b.dataset.i,10)));
    tbody.querySelectorAll('button.del').forEach(b=>b.onclick=()=>{events.splice(parseInt(b.dataset.i,10),1); renderTable();});
  }

  function toLine(ev){
    const pref = (ev.flags||[]).map(f=>REV[f]).filter(Boolean).join('');
    const title = ev.title ? ` # ${ev.title}` : '';
    if(ev.type==='range') return `${pref}${ev.start}-${ev.end}${title}`;
    if(ev.type==='weekly') return `${pref}d${ev.weekday}${title}`;
    return ev.raw||'';
  }

  function exportHday(){
    const text = events.map(toLine).join('\n');
    const blob = new Blob([text],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='export.hday'; a.click();
    URL.revokeObjectURL(a.href);
  }

  function addOrUpdate(){
    const type = document.getElementById('evtType').value;
    const title = document.getElementById('evtTitle').value.trim();
    const flags = Array.from(document.querySelectorAll('.flag:checked'))
                    .map(i=>({a:'half_am',p:'half_pm',b:'business',s:'course',i:'in'})[i.value]);

    if(type==='range'){
      const start = document.getElementById('evtStart').value.trim();
      const end   = (document.getElementById('evtEnd').value.trim() || start);
      const ev = {type, start, end, title, flags, raw: `${flags.map(f=>REV[f]).join('')}${start}-${end}${title?` # ${title}`:''}`};
      if(editIndex>=0){ events[editIndex] = ev; editIndex=-1; } else { events.push(ev); }
    } else {
      const weekday = parseInt(document.getElementById('evtWeekday').value,10);
      const ev = {type, weekday, title, flags, raw: `${flags.map(f=>REV[f]).join('')}d${weekday}${title?` # ${title}`:''}`};
      if(editIndex>=0){ events[editIndex] = ev; editIndex=-1; } else { events.push(ev); }
    }
    renderTable();
    document.getElementById('resetForm').click();
  }

  function loadToForm(i){
    editIndex = i;
    const ev = events[i];
    document.getElementById('evtType').value = ev.type;
    document.getElementById('evtType').dispatchEvent(new Event('change'));
    document.getElementById('evtTitle').value = ev.title || '';
    document.querySelectorAll('.flag').forEach(cb=>cb.checked=false);
    (ev.flags||[]).forEach(f=>{
      const v = {half_am:'a',half_pm:'p',business:'b',course:'s',in:'i'}[f];
      if(v){ const box = document.querySelector(`.flag[value="${v}"]`); if(box) box.checked = true; }
    });
    if(ev.type==='range'){
      document.getElementById('evtStart').value = ev.start || '';
      document.getElementById('evtEnd').value   = ev.end || ev.start || '';
    } else {
      document.getElementById('evtWeekday').value = String(ev.weekday || 0);
    }
    window.scrollTo({top: document.querySelector('.controls').offsetTop - 20, behavior:'smooth'});
  }

  function renderCalendar(){
    const monthEl = document.getElementById('month');
    const cal = document.getElementById('calendar');
    cal.innerHTML='';
    if(!monthEl.value){ alert('Pick a month'); return; }
    const [year, mon] = monthEl.value.split('-').map(Number);
    const first = new Date(year, mon-1, 1);
    const last  = new Date(year, mon, 0);
    for(let i=0;i<first.getDay();i++) cal.appendChild(Object.assign(document.createElement('div'),{className:'day'}));
    const pad = n=>String(n).padStart(2,'0');
    for(let d=1; d<=last.getDate(); d++){
      const cell = document.createElement('div'); cell.className='day';
      const dateStr = `${year}/${pad(mon)}/${pad(d)}`;
      cell.innerHTML = `<div class='date'>${dateStr}</div>`;
      const items = [];
      for(const ev of events){
        if(ev.type==='range' && ev.start && ev.end && dateStr>=ev.start && dateStr<=ev.end){
          items.push(`<div class='item'>${flagsToBadges(ev.flags)} ${ev.title||''}</div>`);
        }
      }
      cell.innerHTML += items.join('');
      cal.appendChild(cell);
    }
  }

  // ===== Wire up UI =====
  document.getElementById('parse').onclick = ()=>{
    events = parseHday(document.getElementById('hdayText').value);
    renderTable();
  };
  document.getElementById('clear').onclick = ()=>{ events = []; renderTable(); };
  document.getElementById('download').onclick = exportHday;
  document.getElementById('add').onclick = addOrUpdate;
  document.getElementById('renderCal').onclick = renderCalendar;
  document.getElementById('evtType').addEventListener('change', (e)=>{
    const type = e.target.value;
    document.getElementById('rangeInputs').style.display  = (type==='range') ? 'block':'none';
    document.getElementById('weeklyInputs').style.display = (type==='weekly') ? 'block':'none';
  });
  document.getElementById('resetForm').onclick = ()=>{
    editIndex=-1;
    document.getElementById('evtType').value='range';
    document.getElementById('evtTitle').value='';
    document.getElementById('evtStart').value='';
    document.getElementById('evtEnd').value='';
    document.getElementById('evtWeekday').value='1';
    document.querySelectorAll('.flag').forEach(cb=>cb.checked=false);
    document.getElementById('evtType').dispatchEvent(new Event('change'));
  };
  document.getElementById('fileIn').onchange = async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    const text = await f.text();
    document.getElementById('hdayText').value = text;
       document.getElementById('parse').click();
  };
</script>
</body>
